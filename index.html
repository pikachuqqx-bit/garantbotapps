<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Trust - Safe & Automatic</title>
    <style>
        /* –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è */
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent-color: #bb86fc;
            --accent-secondary: #03dac6;
            --border-color: #333333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            --text-primary: #121212;
            --text-secondary: #5a5a5a;
            --accent-color: #6200ee;
            --accent-secondary: #018786;
            --border-color: #dddddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            justify-content: center;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            cursor: pointer;
            font-size: 20px;
            padding: 10px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            right: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(187, 134, 252, 0.3);
        }

        .theme-toggle:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(187, 134, 252, 0.5);
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 16px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .button-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .hidden {
            display: none;
        }

        .back-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 16px;
        }

        .deal-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input, .form-textarea {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .currency-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .currency-option {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            background-color: var(--bg-tertiary);
            transition: all 0.2s;
            font-size: 14px;
        }

        .currency-option.selected {
            border-color: var(--accent-color);
            background-color: rgba(187, 134, 252, 0.1);
        }

        .success-message {
            background-color: rgba(3, 218, 198, 0.1);
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
        }

        .deal-link {
            background-color: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
            overflow-wrap: break-word;
            border: 1px solid var(--accent-color);
        }

        .copy-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
        }

        .deal-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            flex: 1;
        }

        .action-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .action-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* –î–æ–±–∞–≤—å—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞ */
        /* ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <div class="header-content">
                <button class="back-button hidden" id="backButton">
                    <i>‚Üê</i>
                </button>
                <div class="logo">
                    <div class="logo-text">üõ° Crystal Trust</div>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <i>üåô</i>
                </button>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="mainScreen">
            <div class="card">
                <div class="button" id="createDealBtn">
                    <i>üíé</i> –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
                </div>
                <div class="button button-secondary" id="myDealsBtn">
                    <i>üìã</i> –ú–æ–∏ —Å–¥–µ–ª–∫–∏
                </div>
                <div class="button button-secondary" id="activeDealsBtn">
                    <i>üîÑ</i> –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
                </div>
                <div class="button button-secondary" id="withdrawBtn">
                    <i>üí∏</i> –í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞
                </div>
                <div class="button button-secondary" id="profileBtn">
                    <i>üë§</i> –ü—Ä–æ—Ñ–∏–ª—å
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ -->
        <div id="createDealScreen" class="hidden">
            <div class="card">
                <div class="deal-form">
                    <div class="form-group">
                        <label class="form-label">–°—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏ (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
                        <textarea class="form-textarea" id="giftLinks" placeholder="https://t.me/nft/PlushPepe-1&#10;https://t.me/nft/PlushPepe-2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–í–∞–ª—é—Ç–∞ –æ–ø–ª–∞—Ç—ã</label>
                        <div class="currency-selector" id="currencySelector">
                            <div class="currency-option" data-currency="TON">üíé TON</div>
                            <div class="currency-option" data-currency="RUB">üá∑üá∫ RUB</div>
                            <div class="currency-option" data-currency="USD">üá∫üá∏ USD</div>
                            <div class="currency-option" data-currency="EUR">üá™üá∫ EUR</div>
                            <div class="currency-option" data-currency="UAH">üá∫üá¶ UAH</div>
                            <div class="currency-option" data-currency="KZT">üá∞üáø KZT</div>
                            <div class="currency-option" data-currency="STARS">‚≠ê Stars</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–°—É–º–º–∞ —Å–¥–µ–ª–∫–∏</label>
                        <input type="number" class="form-input" id="dealAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" step="0.01" min="0.01">
                    </div>
                    
                    <button class="button" id="createDealSubmit">
                        <i>‚úÖ</i> –°–æ–∑–¥–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å–¥–µ–ª–∫—É
                    </button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ -->
        <div id="activeDealsScreen" class="hidden">
            <div class="card">
                <div class="section-title">
                    üîÑ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
                    <span class="sync-indicator" id="activeDealsSync">üîÑ</span>
                </div>
                <div class="deals-list" id="activeDealsList">
                    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ -->
        <div id="dealSuccessScreen" class="hidden">
            <div class="success-message">
                <i>‚úÖ</i> <b>–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</b>
                <div style="font-size: 14px; margin-top: 8px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—é</div>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:</label>
                    <div class="deal-link" id="dealLink">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                    <div class="deal-actions">
                        <button class="action-button action-primary" id="copyDealLink">
                            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                        </button>
                        <button class="action-button action-secondary" id="shareDealLink">
                            üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                        </button>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:</label>
                    <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.4;">
                        1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—é<br>
                        2. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ<br>
                        3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —á–∞—Ç —Å –≥–∞—Ä–∞–Ω—Ç–æ–º<br>
                        4. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –±–æ—Ç–∞-–≥–∞—Ä–∞–Ω—Ç–∞
                    </div>
                </div>
            </div>

            <button class="button" id="backToMainFromSuccess">
                <i>üè†</i> –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            </button>
        </div>

        <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã (–ø—Ä–æ—Ñ–∏–ª—å, –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –∏ —Ç.–¥.) -->
        <!-- ... -->

    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let userData = {};
        let activeDeals = [];

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const mainScreen = document.getElementById('mainScreen');
        const createDealScreen = document.getElementById('createDealScreen');
        const activeDealsScreen = document.getElementById('activeDealsScreen');
        const dealSuccessScreen = document.getElementById('dealSuccessScreen');
        const activeDealsList = document.getElementById('activeDealsList');
        const activeDealsSync = document.getElementById('activeDealsSync');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initializeApp() {
            await loadUserData();
            await loadActiveDeals();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            try {
                showLoading('mainScreen');
                
                const data = {
                    action: 'get_user_data'
                };
                
                const response = await sendToBot(data);
                if (response && response.user_id) {
                    userData = response;
                    updateUserInterface();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            } finally {
                hideLoading();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
        async function loadActiveDeals() {
            try {
                activeDealsSync.classList.add('syncing');
                
                const data = {
                    action: 'get_active_deals'
                };
                
                const response = await sendToBot(data);
                if (response && response.success) {
                    activeDeals = response.deals || [];
                    renderActiveDeals();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫:', error);
            } finally {
                activeDealsSync.classList.remove('syncing');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
        function renderActiveDeals() {
            activeDealsList.innerHTML = '';
            
            if (activeDeals.length === 0) {
                activeDealsList.innerHTML = `
                    <div class="empty-state">
                        <i>üìã</i>
                        <div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
                        <div style="font-size: 14px; margin-top: 8px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–¥–µ–ª–∫—É</div>
                    </div>
                `;
                return;
            }
            
            activeDeals.forEach(deal => {
                const dealElement = createActiveDealElement(deal);
                activeDealsList.appendChild(dealElement);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–¥–µ–ª–∫–∏
        function createActiveDealElement(deal) {
            const dealElement = document.createElement('div');
            dealElement.className = 'deal-item';
            dealElement.innerHTML = `
                <div class="deal-header">
                    <div class="deal-id">#${deal.id.slice(-8)}</div>
                    <div class="deal-status status-active">–ê–∫—Ç–∏–≤–Ω–∞</div>
                </div>
                <div class="deal-details">
                    <div class="deal-amount">${deal.amount} ${deal.currency}</div>
                    <div class="deal-description">${deal.description}</div>
                    <div class="info-row">
                        <span class="info-label">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</span>
                        <span class="info-value">${deal.buyer}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–°–æ–∑–¥–∞–Ω–∞:</span>
                        <span class="info-value">${deal.created_at}</span>
                    </div>
                </div>
                <div class="deal-actions">
                    <button class="action-button action-primary copy-deal-link" 
                            data-link="https://t.me/CrystalsGarantBot?start=${deal.id}">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                </div>
            `;
            return dealElement;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
        async function createDeal() {
            const giftLinks = document.getElementById('giftLinks').value.trim();
            const selectedCurrency = document.querySelector('.currency-option.selected');
            const amount = document.getElementById('dealAmount').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!giftLinks) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏');
                return;
            }
            
            if (!selectedCurrency) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É');
                return;
            }
            
            if (!amount || amount <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }
            
            const currency = selectedCurrency.getAttribute('data-currency');
            
            try {
                showLoading('createDealScreen');
                
                const data = {
                    action: 'create_deal',
                    gift_links: giftLinks,
                    currency: currency,
                    amount: parseFloat(amount),
                    payment_method: getPaymentMethod(currency)
                };
                
                const result = await sendToBot(data);
                
                if (result.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
                    document.getElementById('dealLink').textContent = result.deal_link;
                    showScreen('dealSuccess');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    await loadUserData();
                    await loadActiveDeals();
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    resetDealForm();
                } else {
                    showError(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏');
            } finally {
                hideLoading();
            }
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
        function getPaymentMethod(currency) {
            const methodMap = {
                'TON': 'ton',
                'STARS': 'stars'
            };
            return methodMap[currency] || 'card';
        }

        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã —Å–¥–µ–ª–∫–∏
        function resetDealForm() {
            document.getElementById('giftLinks').value = '';
            document.getElementById('dealAmount').value = '';
            document.querySelectorAll('.currency-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ —Å–¥–µ–ª–∫–∏
        function copyDealLink(link = null) {
            const linkToCopy = link || document.getElementById('dealLink').textContent;
            
            navigator.clipboard.writeText(linkToCopy)
                .then(() => {
                    showTempMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                })
                .catch(err => {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = linkToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showTempMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                });
        }

        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
        function shareDealLink() {
            const link = document.getElementById('dealLink').textContent;
            
            if (navigator.share) {
                navigator.share({
                    title: '–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–¥–µ–ª–∫–∞ Crystal Trust',
                    text: '–ü—Ä–∏–≤–µ—Ç! –ü—Ä–µ–¥–ª–∞–≥–∞—é –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å–¥–µ–ª–∫—É —á–µ—Ä–µ–∑ Crystal Trust:',
                    url: link
                })
                .then(() => console.log('–£—Å–ø–µ—à–Ω—ã–π —à–∞—Ä–∏–Ω–≥'))
                .catch(err => console.log('–û—à–∏–±–∫–∞ —à–∞—Ä–∏–Ω–≥–∞:', err));
            } else {
                copyDealLink(link);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
        async function sendToBot(data) {
            if (window.Telegram && window.Telegram.WebApp) {
                // –í Telegram WebApp
                return new Promise((resolve) => {
                    window.Telegram.WebApp.sendData(JSON.stringify(data));
                    
                    // –°–ª—É—à–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞
                    const handleMessage = (event) => {
                        if (event.data && event.data.startsWith('WEBAPP_DATA:')) {
                            try {
                                const response = JSON.parse(event.data.slice(12));
                                resolve(response);
                            } catch (e) {
                                resolve({ success: false, error: 'Invalid response' });
                            }
                        }
                    };
                    
                    window.addEventListener('message', handleMessage);
                    
                    // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—Ç–≤–µ—Ç–∞
                    setTimeout(() => {
                        window.removeEventListener('message', handleMessage);
                        resolve(mockBotResponse(data));
                    }, 5000);
                });
            } else {
                // –í–Ω–µ Telegram - –º–æ–∫-–æ—Ç–≤–µ—Ç
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve(mockBotResponse(data));
                    }, 1000);
                });
            }
        }

        // –ú–æ–∫-–æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞
        function mockBotResponse(data) {
            switch(data.action) {
                case 'get_user_data':
                    return {
                        user_id: 6521371413,
                        username: '@testuser',
                        rating: 4.8,
                        balance: 1250.50,
                        successful_deals: 12,
                        ton_wallet: 'UQAPAz_HELXWFbD1ZYKUxgRc_h5wPwIUD3wlZslOy5xzpyTg',
                        card_details: '+79290556299 - –°–±–ø'
                    };
                    
                case 'create_deal':
                    const dealId = 'deal_' + Date.now();
                    return {
                        success: true,
                        deal_id: dealId,
                        deal_link: `https://t.me/CrystalsGarantBot?start=${dealId}`,
                        message: '–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ!'
                    };
                    
                case 'get_active_deals':
                    return {
                        success: true,
                        deals: [
                            {
                                id: 'deal_mock_001',
                                amount: 150.50,
                                currency: 'TON',
                                description: 'NFT –∫–æ–ª–ª–µ–∫—Ü–∏—è Premium\n2 —Ä–µ–¥–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–∞',
                                status: 'active',
                                buyer: '–û–∂–∏–¥–∞–µ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è',
                                created_at: new Date().toLocaleString('ru-RU')
                            }
                        ]
                    };
                    
                default:
                    return { success: true };
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI
        function showScreen(screen) {
            document.querySelectorAll('[id$="Screen"]').forEach(el => {
                el.classList.add('hidden');
            });
            document.getElementById(screen + 'Screen').classList.remove('hidden');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
            const backButton = document.getElementById('backButton');
            if (screen === 'main') {
                backButton.classList.add('hidden');
            } else {
                backButton.classList.remove('hidden');
            }
        }

        function showLoading(screen) {
            const element = document.getElementById(screen);
            element.classList.add('loading');
        }

        function hideLoading() {
            document.querySelectorAll('.loading').forEach(el => {
                el.classList.remove('loading');
            });
        }

        function showError(message) {
            showTempMessage(message, 'error');
        }

        function showTempMessage(message, type = 'info') {
            // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? '#f44336' : '#4CAF50'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            messageEl.textContent = message;
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                document.body.removeChild(messageEl);
            }, 3000);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è
            document.getElementById('createDealBtn').addEventListener('click', () => showScreen('createDeal'));
            document.getElementById('activeDealsBtn').addEventListener('click', () => {
                loadActiveDeals();
                showScreen('activeDeals');
            });
            document.getElementById('backButton').addEventListener('click', () => showScreen('main'));
            document.getElementById('backToMainFromSuccess').addEventListener('click', () => showScreen('main'));
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
            document.getElementById('createDealSubmit').addEventListener('click', createDeal);
            
            // –í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã
            document.querySelectorAll('.currency-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.currency-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫
            document.getElementById('copyDealLink').addEventListener('click', () => copyDealLink());
            document.getElementById('shareDealLink').addEventListener('click', shareDealLink);
            
            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
            activeDealsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('copy-deal-link')) {
                    const link = e.target.getAttribute('data-link');
                    copyDealLink(link);
                }
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            document.getElementById('themeToggle').innerHTML = isLight ? '<i>‚òÄÔ∏è</i>' : '<i>üåô</i>';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            document.getElementById('themeToggle').innerHTML = '<i>‚òÄÔ∏è</i>';
        }
    </script>
</body>
</html>
